<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWC Wiki | Viewer</title>
    <style>
        :root {
            --primary: #ff4757;
            --accent: #2ed573;
            --glass-bg: rgba(255, 255, 255, 0.07);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            --text-main: #ffffff;
            --text-muted: #a4b0be;
            --input-bg: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(45deg, #1e272e, #0f2027, #203a43, #2c5364);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transform: translateZ(0); 
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Custom BG Layer */
        #customBgLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background-size: cover; background-position: center; background-repeat: no-repeat;
            opacity: 0; transition: opacity 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: none; filter: blur(25px) brightness(0.4) saturate(1.3); transform: scale(1.1); 
            will-change: opacity;
        }
        #customBgLayer.active { opacity: 1; }

        /* Ambient Orbs */
        .orb { position: absolute; border-radius: 50%; filter: blur(80px); z-index: -2; opacity: 0.6; pointer-events: none;}
        .orb-1 { top: -50px; left: -50px; width: 300px; height: 300px; background: #7f00ff; }
        .orb-2 { bottom: -50px; right: -50px; width: 400px; height: 400px; background: #00d2ff; }
        body.has-custom-bg .orb { opacity: 0; }

        /* Navigation */
        nav {
            background: var(--glass-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--glass-shadow); z-index: 20; flex-shrink: 0;
        }
        nav h1 { margin: 0; font-size: 1.4rem; font-weight: 300; letter-spacing: 1px; cursor: pointer; }
        nav h1 b { font-weight: 700; color: var(--primary); }
        .nav-actions { display: flex; gap: 10px; }

        /* Buttons */
        .btn {
            background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: transform 0.2s ease, box-shadow 0.2s ease; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); will-change: transform;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(255, 71, 87, 0.4); }
        .btn.secondary { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); }
        .btn.secondary:hover { background: rgba(255,255,255,0.2); }
        .btn.small { padding: 4px 10px; font-size: 0.75rem; }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1; }

        /* Main Content */
        .main-content { 
            flex: 1; padding: 0 40px 40px 40px; 
            overflow-y: auto; 
            display: flex; flex-direction: column; margin-left: 0; 
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* PAGE VIEW ANIMATION */
        @keyframes pageSlideIn {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-view { animation: pageSlideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        .search-wrapper { margin-bottom: 30px; width: 100%; max-width: 600px; align-self: flex-start; position: sticky; top: 0; z-index: 15; padding-top: 40px; }
        .search-bar { width: 100%; padding: 15px 25px; background: rgba(30, 39, 46, 0.9); backdrop-filter: blur(10px); border: 1px solid var(--glass-border); border-radius: 30px; color: white; font-size: 1.1rem; box-shadow: var(--glass-shadow); outline: none; transition: border-color 0.2s; }
        .search-bar:focus { border-color: var(--primary); }

        /* --- MEDIUM BUBBLES --- */
        .medium-hub-container {
            display: flex; flex-wrap: wrap; gap: 40px; justify-content: center; align-items: center;
            height: 70vh; align-content: center;
        }
        .medium-bubble {
            width: 200px; height: 200px; border-radius: 50%;
            background: rgba(255,255,255,0.03); 
            border: 2px solid var(--glass-border);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
            transform-style: preserve-3d;
        }
        .medium-bubble:hover {
            border-color: var(--accent); background: rgba(46, 213, 115, 0.1);
        }
        .medium-bubble span { font-size: 1.5rem; font-weight: 700; color: #fff; letter-spacing: 1px; text-transform: uppercase; pointer-events: none; }
        .medium-bubble small { font-size: 0.9rem; color: #aaa; margin-top: 5px; font-weight: 300; pointer-events: none; }

        /* Grid & Sections */
        .medium-section { margin-bottom: 50px; }
        .medium-title { font-size: 1.5rem; color: var(--accent); border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        
        .subcat-title { 
            font-size: 1.2rem; color: #ddd; margin: 40px 0 20px 0; border-bottom: 1px dashed rgba(255,255,255,0.2); 
            padding-bottom: 5px; width: 100%; text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; gap: 10px;
        }

        /* Optimized Grid for Performance */
        .franchise-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 30px; }
        .franchise-bubble {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 20px;
            aspect-ratio: 16/9; display: flex; align-items: center; justify-content: center; cursor: pointer; position: relative;
            transition: transform 0.2s; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
        }
        .franchise-bubble:hover { border-color: var(--primary); }
        .franchise-bubble h2 { font-size: 1.8rem; font-weight: 800; color: white; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.5); margin: 0; padding: 10px; z-index: 2; pointer-events: none; }
        .franchise-logo-img { width: 80%; height: 80%; object-fit: contain; z-index: 1; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); pointer-events: none; }
        
        .franchise-count-badge {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.7); 
            color: #ccc; font-size: 0.7rem; padding: 3px 10px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1); pointer-events: none; z-index: 4;
            backdrop-filter: blur(4px);
        }

        .char-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; 
        }
        .franchise-header-bar { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; border-bottom: 2px solid var(--glass-border); padding-bottom: 20px; }
        .back-btn { background: transparent; border: 1px solid var(--glass-border); color: var(--accent); padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .back-btn:hover { background: rgba(46, 213, 115, 0.1); border-color: var(--accent); }
        
        .char-card { 
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; 
            overflow: hidden; cursor: pointer; transition: transform 0.2s ease, border-color 0.2s ease; position: relative; 
            transform-style: preserve-3d;
        }
        .char-card:hover { background: rgba(255,255,255,0.08); border-color: var(--primary); }
        .card-img { 
            width: 100%; height: 220px; object-fit: cover; background-color: #000; opacity: 0.9; 
            will-change: opacity;
        }
        .char-card:hover .card-img { opacity: 1; }
        .card-info { padding: 15px; text-align: center; pointer-events: none; }
        .card-name { font-weight: 600; font-size: 1.1rem; letter-spacing: 0.5px; }
        .card-sub { font-size: 0.8rem; color: var(--accent); margin-top: 3px; font-style: italic; opacity: 0.8; }
        .card-img-wrapper { width: 100%; height: 220px; overflow: hidden; background-color: #000; position: relative; pointer-events: none; }

        /* Modals & Wiki */
        .page-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .page-overlay.active { display: flex; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .wiki-page { background: #131518; border: 1px solid var(--glass-border); width: 90%; max-width: 1200px; height: 90%; border-radius: 16px; display: flex; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.6); position: relative; }
        .close-btn { position: absolute; top: 20px; right: 25px; background: none; border: none; color: var(--text-muted); font-size: 2rem; cursor: pointer; z-index: 200; }
        
        .wiki-sidebar { width: 350px; background: rgba(0,0,0,0.2); border-right: 1px solid var(--glass-border); padding: 30px; overflow-y: auto; flex-shrink: 0; text-align: center; }
        .wiki-portrait { width: 100%; height: 100%; object-fit: cover; }
        .wiki-portrait-wrapper { width: 100%; aspect-ratio: 2/3; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--glass-border); overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.5); }
        .wiki-meta { text-align: left; font-size: 0.9rem; color: var(--text-muted); margin-top: 20px; }
        .wiki-meta p { margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px; }
        .wiki-meta strong { color: var(--primary); display: block; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 2px; }
        
        /* Wiki Content Container */
        .wiki-content-wrapper { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Sliding Animations */
        @keyframes slideInRight { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-right { animation: slideInRight 0.2s ease-out; }
        .slide-left { animation: slideInLeft 0.2s ease-out; }

        .wiki-content { flex: 1; padding: 40px 50px; overflow-y: auto; width: 100%; }
        
        .wiki-title h1 { margin: 0; font-size: 3rem; background: linear-gradient(to right, #fff, #a4b0be); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .wiki-title span { font-size: 1.4rem; color: var(--accent); font-style: italic; font-weight: 300; display: block; margin-top: 5px; }
        .wiki-quote { font-size: 1.1rem; color: rgba(255, 255, 255, 0.8); font-style: italic; margin-top: 15px; padding-left: 15px; border-left: 3px solid rgba(255, 255, 255, 0.2); font-family: 'Segoe UI', serif; }

        h3 { color: var(--text-main); margin-top: 35px; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px; font-weight: 300; letter-spacing: 1px; }
        .gwc-box { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); border-left: 4px solid var(--primary); padding: 15px; margin: 15px 0; border-radius: 0 8px 8px 0; line-height: 1.6; color: #ddd; }
        .gwc-box strong { color: var(--primary); font-size: 0.85rem; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .gwc-media-embed { margin-top: 15px; width: 100%; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); position:relative; }
        .gwc-media-embed img { width: 100%; height: auto; display: block; }
        .gwc-media-embed iframe { width: 100%; aspect-ratio: 16/9; display: block; border: none; }
        .fallback-link { padding: 8px; text-align: center; font-size: 0.8rem; background: rgba(0,0,0,0.6); }
        .fallback-link a { color: #aaa; text-decoration: none; }
        .fallback-link a:hover { color: white; text-decoration: underline; }

        .lbo-accordion { margin-bottom: 10px; border: 1px solid var(--glass-border); border-radius: 6px; overflow: hidden; }
        .lbo-acc-header { background: rgba(255,255,255,0.1); padding: 10px 15px; cursor: pointer; font-weight: bold; color: var(--accent); display: flex; justify-content: space-between; transition: background 0.2s; }
        .lbo-acc-header:hover { background: rgba(255,255,255,0.15); }
        .lbo-acc-body { display: none; padding: 15px; background: rgba(0,0,0,0.2); }
        .lbo-acc-body.open { display: block; }
        .lbo-level-item { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .lbo-level-img-container { margin-top: 8px; margin-bottom: 5px; border-radius: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); }
        .lbo-level-img { width: 100%; height: auto; max-height: 350px; object-fit: cover; display: block; }

        .lbo-content-grid { display: flex; gap: 20px; align-items: flex-start; }
        .lbo-poster { width: 140px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .lbo-level-list { flex: 1; }

        .vehicle-toggle-btn { float: right; padding: 2px 8px; font-size: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); border-radius: 4px; color: white; cursor: pointer; }
        .vehicle-preview-container { display: none; margin-top: 15px; animation: fadeIn 0.3s ease; }
        .vehicle-preview-container.open { display: block; }

        .skins-container { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
        .skin-group { border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        .skin-cat { font-size: 0.9rem; font-weight: 700; color: var(--accent); margin-bottom: 8px; text-transform: uppercase; display: flex; align-items: center; gap: 10px; }
        .skin-cat::after { content:''; flex:1; height:1px; background: var(--glass-border); }
        .skin-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .skin-pill { 
            background: rgba(46, 213, 115, 0.15); color: #fff; padding: 4px 12px; border-radius: 12px; 
            font-size: 0.85rem; border: 1px solid rgba(46, 213, 115, 0.3); white-space: nowrap; 
            cursor: pointer; transition: all 0.2s; position: relative; z-index: 10;
        }
        .skin-pill:hover { background: rgba(46, 213, 115, 0.4); transform: scale(1.05); }
        .skin-pill.gwcog { background: rgba(255, 71, 87, 0.2); border-color: var(--primary); color: #ffcccb; font-weight: bold; }
        .skin-pill.gwcog:hover { background: rgba(255, 71, 87, 0.4); }
        .skin-pill.has-image { border-bottom: 2px solid white; box-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .skin-pill.main-skin { background: rgba(255, 255, 255, 0.15); border-color: rgba(255,255,255,0.3); color: #aaa; font-style: italic; }
        .skin-pill.main-skin:hover { background: rgba(255, 255, 255, 0.25); color: white; }
        
        #skinTooltip { position: fixed; pointer-events: none; z-index: 20000; border: 2px solid white; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 180px; aspect-ratio: 2/3; display: none; background: #000; }
        #skinTooltip img { width: 100%; height: 100%; object-fit: cover; }

        .skin-modal-content { background: #1e272e; width: 550px; padding: 30px; border-radius: 12px; border: 1px solid var(--glass-border); text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
        .skin-preview { width: 100%; aspect-ratio: 2/3; max-height: 500px; object-fit: cover; background: #000; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; transition: object-position 0.1s; }
        .skin-preview-wrapper { width: 100%; aspect-ratio: 2/3; max-height: 500px; border-radius: 8px; overflow: hidden; margin-bottom: 20px; border: 1px solid #333; background: #000; }
        .skin-modal-title { color: var(--accent); font-size: 1.5rem; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;}

        /* ABOUT PAGE STYLES */
        .about-container { max-width: 900px; margin: 0 auto; padding-top: 20px; color: #ddd; }
        .about-header { text-align: center; margin-bottom: 40px; }
        .about-header h2 { font-size: 2.5rem; color: white; margin: 0; font-weight: 300; }
        .about-header span { color: var(--primary); font-weight: 700; letter-spacing: 1px; }
        .about-intro { font-size: 1.2rem; line-height: 1.6; border-bottom: 1px solid var(--glass-border); padding-bottom: 20px; margin-bottom: 30px; text-align: center; }
        
        .glossary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .glossary-card { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; padding: 20px; transition: transform 0.2s; transform-style: preserve-3d; }
        .glossary-card:hover { transform: translateY(-3px); background: rgba(255,255,255,0.05); }
        .term-title { color: var(--primary); font-size: 1.1rem; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; pointer-events: none;}
        .term-desc { font-size: 0.95rem; line-height: 1.5; color: #ccc; pointer-events: none;}
        
        .gwcog-feature { 
            grid-column: 1 / -1; 
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.1), rgba(46, 213, 115, 0.02));
            border: 1px solid var(--accent); 
            box-shadow: 0 4px 20px rgba(46, 213, 115, 0.1);
        }
        .gwcog-feature .term-title { color: var(--accent); font-size: 1.4rem; }

        /* --- STATS PAGE STYLES --- */
        .stats-summary { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px; }
        .stats-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 30px; border-radius: 16px; text-align: center; }
        .stats-card h4 { margin: 0; color: var(--accent); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .stats-card .val { display: block; font-size: 3.5rem; font-weight: 800; margin-top: 10px; color: #fff; }

        .timeline-container { position: relative; padding: 20px 0; margin-top: 40px; }
        .timeline-year-block { margin-bottom: 40px; position: relative; padding-left: 120px; border-left: 2px solid var(--glass-border); }
        .timeline-year-label { position: absolute; left: 0; top: 0; font-size: 1.8rem; font-weight: 800; color: var(--primary); width: 100px; text-align: right; }
        .timeline-char-list { display: flex; flex-wrap: wrap; gap: 10px; }
        .timeline-char-pill { background: rgba(255,255,255,0.07); border: 1px solid var(--glass-border); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .timeline-char-pill:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        .timeline-char-pill small { color: rgba(255,255,255,0.4); margin-left: 5px; }
        .timeline-char-pill:hover small { color: rgba(0,0,0,0.6); }

        /* --- NEW STATS STYLES --- */
        .stats-row { display: flex; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .stats-panel { flex: 1; min-width: 300px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 25px; border-radius: 16px; }
        .stats-panel h3 { margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; font-size: 1.1rem; color: var(--accent); }

        /* Pie Chart */
        .pie-container { display: flex; align-items: center; gap: 30px; justify-content: center; margin-top: 20px; }
        .pie-chart {
            width: 180px; height: 180px; border-radius: 50%;
            background: conic-gradient(var(--segments));
            position: relative; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        .pie-chart::after {
            content: ""; position: absolute; inset: 60px; /* donut hole */
            background: #131518; border-radius: 50%;
        }
        .pie-legend { display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem; }
        .legend-item { display: flex; align-items: center; gap: 10px; color: #ccc; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }

        /* Leaderboard */
        .leaderboard-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .lb-item { 
            display: flex; align-items: center; justify-content: space-between; 
            background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 8px; 
            border-left: 3px solid transparent; transition: transform 0.2s;
        }
        .lb-item:hover { transform: translateX(5px); background: rgba(255,255,255,0.08); }
        .lb-item:nth-child(1) { border-color: #ffd700; } /* Gold */
        .lb-item:nth-child(2) { border-color: #c0c0c0; } /* Silver */
        .lb-item:nth-child(3) { border-color: #cd7f32; } /* Bronze */
        .lb-rank { font-weight: bold; color: var(--primary); width: 30px; }
        .lb-name { flex: 1; font-weight: 600; color: #fff; }
        .lb-count { background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 10px; font-size: 0.85rem; color: #aaa; }

        /* --- 3D TILT EFFECT --- */
        .tilted-element {
            transform-style: preserve-3d;
            will-change: transform;
            transition: transform 0.4s ease-out; 
        }

    </style>
</head>
<body>

<div id="customBgLayer"></div>
<div class="orb orb-1"></div>
<div class="orb orb-2"></div>
<div id="skinTooltip"><img id="skinTooltipImg" src=""></div>

<nav>
    <h1 onclick="goHome()"><b>GWC</b> Wiki <span style="font-size:0.8rem; opacity:0.6; font-weight:300;">(Read Only)</span></h1>
    <div class="nav-actions">
        <button class="btn" onclick="viewStats()">Dashboard / Stats</button>
        <button class="btn secondary" onclick="viewAbout()">Glossary</button>
    </div>
</nav>

<div class="container">
    <div class="main-content">
        <div class="search-wrapper"><input type="text" id="search" class="search-bar" placeholder="Search Characters, OWL, Media..." onkeyup="handleSearch()"></div>
        <div id="mainViewContainer"></div>
    </div>
</div>

<div id="pageOverlay" class="page-overlay" onclick="closePage(event)">
    <div class="wiki-page" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closePageDirect()">×</button>
        <div id="wikiPageContainer" class="wiki-content-wrapper">
            </div>
    </div>
</div>

<div id="skinOverlay" class="page-overlay" onclick="closeSkinModal(event)">
    <div class="skin-modal-content" onclick="event.stopPropagation()">
        <h2 class="skin-modal-title"><span id="skinModalNameDisplay">Skin Name</span></h2>
        <div id="skinViewArea">
            <div class="skin-preview-wrapper">
                <img id="skinPreviewImg" class="skin-preview" src="">
            </div>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn secondary" onclick="closeSkinModalDirect()">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- READ ONLY MODE VARIABLES ---
    let gwcData = { chars: [], meta: {} };
    
    let currentView = 'home'; 
    let selectedMedium = null;
    let selectedFranchise = null;
    let characterPlaylist = []; 
    let currentPlaylistIndex = -1;

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('data.json');
            if(!response.ok) throw new Error("Failed to load data.json");
            gwcData = await response.json();
        } catch(e) {
            console.error(e);
            document.getElementById('mainViewContainer').innerHTML = `<div style="text-align:center; margin-top:50px;"><h2>Error loading data</h2><p>Please ensure 'data.json' is present in the repository.</p></div>`;
            return;
        }

        await renderMainView();
        init3DTilt();
        
        document.addEventListener('keydown', (e) => {
            const overlay = document.getElementById('pageOverlay');
            if(overlay.classList.contains('active')) {
                if(e.key === "ArrowLeft") navigateChar(-1);
                if(e.key === "ArrowRight") navigateChar(1);
            }
        });
    });

    function init3DTilt() {
        const targets = document.querySelectorAll('.medium-bubble, .franchise-bubble, .char-card, .glossary-card');
        targets.forEach(el => {
            if(el.dataset.tiltAttached) return; 
            el.dataset.tiltAttached = "true";
            el.classList.add('tilted-element');

            el.addEventListener('mousemove', (e) => {
                const rect = el.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const rotateX = ((y - centerY) / centerY) * -8; 
                const rotateY = ((x - centerX) / centerX) * 8;
                el.style.transition = 'transform 0.05s linear'; 
                el.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.04, 1.04, 1.04)`;
            });

            el.addEventListener('mouseleave', () => {
                el.style.transition = 'transform 0.4s ease-out'; 
                el.style.transform = ''; 
            });
        });
    }

    // --- DATA GETTERS (Sync in Read-Only Mode) ---
    function getChars() { return gwcData.chars || []; }
    function getFranchiseMeta() { return gwcData.meta || {}; }

    function getAllFranchiseNames() {
        const chars = getChars();
        const meta = getFranchiseMeta();
        const fromChars = chars.map(c => c.universe);
        const fromMeta = Object.keys(meta);
        return [...new Set([...fromChars, ...fromMeta])];
    }

    // --- UTILITIES ---
    function getYouTubeId(url) { 
        if(!url) return null; 
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/; 
        const match = url.match(regExp); 
        return (match && match[2].length === 11) ? match[2] : null; 
    }
    
    function renderMediaBox(url) { 
        if(!url) return ''; 
        const ytId = getYouTubeId(url); 
        if(ytId) { 
            return `<div class="gwc-media-embed"><iframe src="https://www.youtube-nocookie.com/embed/${ytId}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe><div class="fallback-link"><a href="https://www.youtube.com/watch?v=${ytId}" target="_blank">⚠️ Video not playing? Watch on YouTube</a></div></div>`; 
        } 
        return `<div class="gwc-media-embed"><img src="${url}" onerror="this.style.display='none'"></div>`; 
    }
    
    function toggleVehiclePreview(btn) { 
        const container = btn.nextElementSibling; 
        container.classList.toggle('open'); 
        btn.innerText = container.classList.contains('open') ? '▲ Hide' : '▼ Preview'; 
    }
    
    function escapeSkinName(str) { 
        return str.replace(/"/g, '&quot;'); 
    }
    
    function extractYearAndTitle(firstAppString) {
        if (!firstAppString) return { year: 9999, title: "zzzz" };
        let yearMatch = firstAppString.match(/,\s*(\d{4})$/);
        if (!yearMatch) { yearMatch = firstAppString.match(/\((\d{4})\)/); }
        if (!yearMatch) { yearMatch = firstAppString.match(/(\d{4})/); }
        const year = yearMatch ? parseInt(yearMatch[1]) : 9999;
        let title = firstAppString.replace(yearMatch ? yearMatch[0] : '', '').trim();
        if (title.endsWith(',')) title = title.slice(0, -1).trim();
        if (!title) title = "zzzz";
        return { year, title };
    }
    
    function getLevelCount(c) {
        let count = 0;
        if (Array.isArray(c.lbo)) {
            c.lbo.forEach(m => { if(m.levels) count += m.levels.length; });
        } else if (c.lbo && typeof c.lbo === 'string') {
            count += c.lbo.split('\n').filter(l => l.trim().length > 0).length;
        }
        return count;
    }
    
    function compareCharacters(a, b) {
        const faA = extractYearAndTitle(a.firstApp); 
        const faB = extractYearAndTitle(b.firstApp);
        if (faA.year !== faB.year) return faA.year - faB.year;
        const levelsA = getLevelCount(a);
        const levelsB = getLevelCount(b);
        if (levelsA !== levelsB) return levelsB - levelsA;
        const titleComparison = faA.title.localeCompare(faB.title);
        if (titleComparison !== 0) return titleComparison;
        return a.name.localeCompare(b.name);
    }

    /* --- RENDERER --- */
    async function renderMainView() {
        const container = document.getElementById('mainViewContainer'); 
        
        container.classList.remove('animate-view');
        void container.offsetWidth; 
        container.classList.add('animate-view');

        container.innerHTML = '';
        
        const chars = getChars();
        const meta = getFranchiseMeta();
        const bgLayer = document.getElementById('customBgLayer');

        if(currentView === 'franchise' && selectedFranchise && meta[selectedFranchise] && meta[selectedFranchise].bg) {
            bgLayer.style.backgroundImage = `url('${meta[selectedFranchise].bg}')`;
            bgLayer.classList.add('active'); 
            document.body.classList.add('has-custom-bg');
        } else {
            bgLayer.classList.remove('active'); 
            document.body.classList.remove('has-custom-bg');
            setTimeout(() => { if(!bgLayer.classList.contains('active')) bgLayer.style.backgroundImage = ''; }, 800);
        }
        
        characterPlaylist = []; 

        const frag = document.createDocumentFragment();

        if (currentView === 'home') {
            const franchises = getAllFranchiseNames();
            let activeMediums = new Set();
            franchises.forEach(f => {
                let m = (meta[f] && meta[f].medium) ? meta[f].medium : "Uncategorized";
                activeMediums.add(m);
            });
            
            const defaultMediums = ["Film", "TV", "Video Game", "Comic", "Literature"];
            activeMediums.forEach(m => { if(!defaultMediums.includes(m)) defaultMediums.push(m); });
            
            if(defaultMediums.includes("Uncategorized")) {
                defaultMediums.splice(defaultMediums.indexOf("Uncategorized"), 1);
                defaultMediums.push("Uncategorized");
            }

            const hub = document.createElement('div');
            hub.className = 'medium-hub-container';
            
            defaultMediums.forEach(med => {
                let count = franchises.filter(f => {
                    let fm = (meta[f] && meta[f].medium) ? meta[f].medium : "Uncategorized";
                    return fm === med;
                }).length;

                if(count > 0 || med === "Film" || med === "TV" || med === "Video Game") {
                    const bubble = document.createElement('div');
                    bubble.className = 'medium-bubble';
                    bubble.innerHTML = `<span>${med}</span><small>${count} Franchise${count!==1?'s':''}</small>`;
                    bubble.onclick = () => viewMedium(med);
                    hub.appendChild(bubble);
                }
            });
            frag.appendChild(hub);
        }

        else if (currentView === 'medium') {
            const allFranchises = getAllFranchiseNames();
            const myFranchises = allFranchises.filter(f => {
                let m = (meta[f] && meta[f].medium) ? meta[f].medium : "Uncategorized";
                return m === selectedMedium;
            });
            
            const header = document.createElement('div');
            header.className = 'franchise-header-bar';
            header.innerHTML = `<button class="back-btn" onclick="goHome()">← Back to Hub</button><h2 style="margin:0;">${selectedMedium}</h2>`;
            frag.appendChild(header);
            
            let groups = {};
            let noGroup = [];
            
            myFranchises.forEach(f => {
                if (meta[f] && meta[f].group && meta[f].group.trim() !== "") {
                    let g = meta[f].group.trim();
                    if(!groups[g]) groups[g] = [];
                    groups[g].push(f);
                } else {
                    noGroup.push(f);
                }
            });

            const getFranchiseLevelCount = (charList) => {
                let count = 0;
                charList.forEach(c => {
                    if (Array.isArray(c.lbo)) {
                        c.lbo.forEach(m => { if(m.levels) count += m.levels.length; });
                    } else if (c.lbo && typeof c.lbo === 'string') {
                        count += c.lbo.split('\n').filter(l => l.trim().length > 0).length;
                    }
                });
                return count;
            };
            
            const renderGrid = (list, title) => {
                if(list.length === 0) return;
                const section = document.createElement('div');
                section.className = 'medium-section';
                if(title) section.innerHTML = `<div class="medium-title" style="font-size:1.2rem; border-bottom:1px dashed var(--glass-border);">${title}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'franchise-grid';
                
                list.sort((a, b) => {
                    const charsA = chars.filter(c => c.universe === a);
                    const charsB = chars.filter(c => c.universe === b);
                    if (charsA.length !== charsB.length) return charsB.length - charsA.length;
                    const levelsA = getFranchiseLevelCount(charsA);
                    const levelsB = getFranchiseLevelCount(charsB);
                    if (levelsA !== levelsB) return levelsB - levelsA;
                    return a.localeCompare(b);
                });

                list.forEach(f => {
                    const bubble = document.createElement('div');
                    bubble.className = 'franchise-bubble';
                    bubble.onclick = () => viewFranchise(f);
                    const hasLogo = meta[f] && meta[f].logo;
                    let content = `<h2>${f}</h2>`;
                    if(hasLogo) content = `<img src="${meta[f].logo}" class="franchise-logo-img" alt="${f}">`;
                    
                    const franchiseChars = chars.filter(c => c.universe === f);
                    const charCount = franchiseChars.length;
                    const levelCount = getFranchiseLevelCount(franchiseChars);
                    
                    bubble.innerHTML = `${content}
                    <div class="franchise-count-badge">${charCount} Char${charCount!==1?'s':''} | ${levelCount} Lvl${levelCount!==1?'s':''}</div>`;
                    grid.appendChild(bubble);
                });
                section.appendChild(grid);
                frag.appendChild(section);
            };

            Object.keys(groups).sort((a, b) => {
                const lenA = groups[a].length;
                const lenB = groups[b].length;
                if(lenA !== lenB) return lenB - lenA; 
                return a.localeCompare(b); 
            }).forEach(g => renderGrid(groups[g], g));
            
            renderGrid(noGroup, Object.keys(groups).length > 0 ? "General" : null);
        }

        else if (currentView === 'franchise') {
            const filtered = chars.filter(c => c.universe === selectedFranchise);
            filtered.sort(compareCharacters);
            
            const hasSubcats = filtered.some(c => c.subcategory && c.subcategory.trim() !== "");
            const hasLogo = meta[selectedFranchise] && meta[selectedFranchise].logo;
            let headerContent = `<h2 style="margin:0; font-size:2rem;">${selectedFranchise}</h2>`;
            if(hasLogo) headerContent = `<img src="${meta[selectedFranchise].logo}" style="height:60px; filter:drop-shadow(0 0 5px rgba(255,255,255,0.5));">`;
            
            let mediumName = (meta[selectedFranchise] && meta[selectedFranchise].medium) ? meta[selectedFranchise].medium : "Uncategorized";
            
            const header = document.createElement('div');
            header.className = 'franchise-header-bar';
            header.innerHTML = `<button class="back-btn" onclick="viewMedium('${mediumName}')">← Back to ${mediumName}</button>${headerContent}`;
            frag.appendChild(header);

            if (filtered.length === 0) {
                 const emptyMsg = document.createElement('div');
                 emptyMsg.style.textAlign = 'center';
                 emptyMsg.style.marginTop = '50px';
                 emptyMsg.innerHTML = `<div style="color:var(--text-muted); font-size:1.2rem; margin-bottom:20px;">No characters yet!</div>`;
                 frag.appendChild(emptyMsg);
            }
            else if (hasSubcats) {
                let subGroups = {};
                filtered.forEach(c => {
                    let sub = c.subcategory ? c.subcategory.trim() : "General";
                    if(sub === "") sub = "General";
                    if(!subGroups[sub]) subGroups[sub] = [];
                    subGroups[sub].push(c);
                });

                let orderedKeys = Object.keys(subGroups).sort();
                if(meta[selectedFranchise] && meta[selectedFranchise].subcatOrder) {
                    const savedOrder = meta[selectedFranchise].subcatOrder;
                    orderedKeys.sort((a,b) => {
                        const idxA = savedOrder.indexOf(a); const idxB = savedOrder.indexOf(b);
                        if(idxA !== -1 && idxB !== -1) return idxA - idxB;
                        if(idxA !== -1) return -1; if(idxB !== -1) return 1;
                        return a.localeCompare(b);
                    });
                }

                orderedKeys.forEach(sub => {
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'subcat-title';
                    titleDiv.innerHTML = `${sub}`;
                    frag.appendChild(titleDiv);

                    const grid = document.createElement('div'); 
                    grid.className = 'char-grid';
                    
                    const groupChars = subGroups[sub].sort(compareCharacters);
                    groupChars.forEach(char => {
                        characterPlaylist.push(char.id);
                        renderCharCard(char, grid);
                    });
                    frag.appendChild(grid);
                });
            } else {
                const grid = document.createElement('div'); 
                grid.className = 'char-grid';
                filtered.forEach(char => {
                    characterPlaylist.push(char.id);
                    renderCharCard(char, grid);
                });
                frag.appendChild(grid);
            }

        } else if (currentView === 'search') {
            const query = document.getElementById('search').value.toLowerCase();
            
            const filtered = chars.filter(c => {
                if (c.name.toLowerCase().includes(query)) return true;
                if (c.universe.toLowerCase().includes(query)) return true;
                if (c.subcategory && c.subcategory.toLowerCase().includes(query)) return true;
                if (c.firstApp && c.firstApp.toLowerCase().includes(query)) return true;
                if (c.owl && c.owl.toLowerCase().includes(query)) return true;

                if (c.lbo) {
                    if (Array.isArray(c.lbo)) {
                        if (c.lbo.some(m => m.media && m.media.toLowerCase().includes(query))) return true;
                    } else if (typeof c.lbo === 'string') {
                        if (c.lbo.toLowerCase().includes(query)) return true;
                    }
                }
                
                return false;
            });

            filtered.sort(compareCharacters); 
            
            const h3 = document.createElement('h3');
            h3.style.marginTop = '0';
            h3.innerText = 'Global Search Results';
            frag.appendChild(h3);
            
            const grid = document.createElement('div');
            grid.className = 'char-grid';
            filtered.forEach(char => {
                characterPlaylist.push(char.id);
                renderCharCard(char, grid);
            });
            frag.appendChild(grid);
        } else if (currentView === 'about') {
            const aboutDiv = document.createElement('div');
            aboutDiv.className = 'about-container';
            aboutDiv.innerHTML = `
                <div class="franchise-header-bar"><button class="back-btn" onclick="goHome()">← Back to Hub</button></div>
                <div class="about-header">
                    <h2>About <span>GWC</span></h2>
                </div>
                <div class="about-intro">
                    Gannon’s World Collider is a crossover video game, and not just that, but the biggest crossover in media history. 
                    Merging countless universes into a singular, interactive experience.
                </div>
                
                <h3 style="text-align:center; border:none; margin-bottom:30px;">Glossary of Terms</h3>
                <div class="glossary-grid">
                    <div class="glossary-card">
                        <span class="term-title">OWL <span>Open World Location</span></span>
                        <div class="term-desc">
                            Each IP gets a separate Open World. Open Worlds will have a few things there, but for main locations, you must get the characters assigned to those locations.
                        </div>
                    </div>

                    <div class="glossary-card">
                        <span class="term-title">UM <span>Ultimate Move</span></span>
                        <div class="term-desc">
                            Powerful signature abilities. Ultimate Moves do not work on Bosses, unless either they aren’t insta-kill or the Boss is at 5% or less health.
                        </div>
                    </div>

                    <div class="glossary-card">
                        <span class="term-title">LBO <span>Levels Based Off...</span></span>
                        <div class="term-desc">
                            General level counts per piece of media are 5 levels. However, multi-season TV shows are handled on a case-by-case basis.
                        </div>
                    </div>

                    <div class="glossary-card">
                        <span class="term-title">VU <span>Vehicle Unlock</span></span>
                        <div class="term-desc">
                            A vehicle that instantly comes with the character, no progression required. Characters that are always in vehicles will default to them.
                        </div>
                    </div>

                    <div class="glossary-card">
                        <span class="term-title">Skins <span>Alterations</span></span>
                        <div class="term-desc">
                            Different alterations to the character's look that typically do not affect stats. If a listed character skin is vastly different from the default, assume stats and mechanics will be affected.
                        </div>
                    </div>

                    <div class="glossary-card gwcog-feature">
                        <span class="term-title">GWCOG <span>Gannon’s World Collider Original</span></span>
                        <div class="term-desc">
                            Stands for <strong>Gannon’s World Collider Original</strong>. This tag denotes that a specific element—such as a Skin, LBO Storyline, or mechanic—is an original creation unique to the GWC universe.
                        </div>
                    </div>
                </div>
            `;
            frag.appendChild(aboutDiv);
        } else if (currentView === 'stats') {
            const statsContainer = document.createElement('div');
            statsContainer.className = 'about-container animate-view';
            statsContainer.style.maxWidth = '1100px'; 

            let totalLevels = 0;
            const yearsMap = {};
            const franchiseCounts = {}; 
            const mediumCounts = {};    

            chars.forEach(c => {
                if (Array.isArray(c.lbo)) {
                    c.lbo.forEach(m => { if(m.levels) totalLevels += m.levels.length; });
                } else if (c.lbo && typeof c.lbo === 'string') {
                    totalLevels += c.lbo.split('\n').filter(l => l.trim().length > 0).length;
                }

                const yearInfo = extractYearAndTitle(c.firstApp);
                const year = yearInfo.year;
                if (year !== 9999) {
                    if (!yearsMap[year]) yearsMap[year] = [];
                    yearsMap[year].push(c);
                }

                const uni = c.universe;
                franchiseCounts[uni] = (franchiseCounts[uni] || 0) + 1;

                const mData = meta[uni] || {};
                const medium = mData.medium || "Uncategorized";
                mediumCounts[medium] = (mediumCounts[medium] || 0) + 1;
            });

            const sortedFranchises = Object.entries(franchiseCounts)
                .sort((a, b) => b[1] - a[1]) 
                .slice(0, 5); 

            let leaderboardHtml = `<div class="leaderboard-list">`;
            sortedFranchises.forEach((item, index) => {
                leaderboardHtml += `
                    <div class="lb-item" onclick="viewFranchise('${item[0].replace(/'/g, "\\'")}')" style="cursor:pointer;">
                        <span class="lb-rank">#${index + 1}</span>
                        <span class="lb-name">${item[0]}</span>
                        <span class="lb-count">${item[1]} Char${item[1] !== 1 ? 's' : ''}</span>
                    </div>`;
            });
            leaderboardHtml += `</div>`;

            const distinctMediums = Object.entries(mediumCounts).sort((a, b) => b[1] - a[1]);
            const totalChars = chars.length;
            let conicSegments = [];
            let currentDeg = 0;
            let legendHtml = `<div class="pie-legend">`;
            const chartColors = ['#ff4757', '#2ed573', '#1e90ff', '#ffa502', '#a55eea', '#535c68', '#ff6b81', '#7bed9f'];

            distinctMediums.forEach((item, index) => {
                const name = item[0];
                const count = item[1];
                const percent = (count / totalChars) * 100;
                const deg = (count / totalChars) * 360;
                const color = chartColors[index % chartColors.length];
                conicSegments.push(`${color} ${currentDeg}deg ${currentDeg + deg}deg`);
                currentDeg += deg;
                legendHtml += `
                    <div class="legend-item">
                        <div class="legend-dot" style="background:${color}"></div>
                        <span>${name} <small>(${Math.round(percent)}%)</small></span>
                    </div>`;
            });
            legendHtml += `</div>`;
            
            const pieStyle = distinctMediums.length > 0 ? `--segments: ${conicSegments.join(', ')}` : 'background: #333';

            const sortedYears = Object.keys(yearsMap).sort((a,b) => a - b);
            let timelineHtml = '<div class="timeline-container">';
            sortedYears.forEach(year => {
                timelineHtml += `
                    <div class="timeline-year-block">
                        <div class="timeline-year-label">${year}</div>
                        <div class="timeline-char-list">
                            ${yearsMap[year].map(char => `<div class="timeline-char-pill" onclick="openPage(${char.id})">${char.name} <small>(${char.universe})</small></div>`).join('')}
                        </div>
                    </div>`;
            });
            timelineHtml += '</div>';

            statsContainer.innerHTML = `
                <div class="franchise-header-bar"><button class="back-btn" onclick="goHome()">← Back to Hub</button></div>
                <div class="about-header"><h2>Wiki <span>Stats</span></h2></div>
                
                <div class="stats-summary">
                    <div class="stats-card"><h4>Total Characters</h4><span class="val">${chars.length}</span></div>
                    <div class="stats-card"><h4>Total Levels</h4><span class="val">${totalLevels}</span></div>
                </div>

                <div class="stats-row">
                    <div class="stats-panel">
                        <h3>Biggest Franchises</h3>
                        ${leaderboardHtml}
                    </div>

                    <div class="stats-panel">
                        <h3>Medium Breakdown</h3>
                        <div class="pie-container">
                            <div class="pie-chart" style="${pieStyle}"></div>
                            ${legendHtml}
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom:20px;">Character Timeline <small style="font-size:0.8rem; color:var(--text-muted);">(By First Appearance Year)</small></h3>
                ${timelineHtml}
            `;
            frag.appendChild(statsContainer);
        }
        
        container.appendChild(frag);
        init3DTilt();
    }

    function renderCharCard(char, container) {
        const card = document.createElement('div'); 
        card.className = 'char-card'; 
        card.onclick = () => openPage(char.id);
        
        const cx = char.imgCrop ? char.imgCrop.x : 50; 
        const cy = char.imgCrop ? char.imgCrop.y : 50;
        const cz = char.imgCrop && char.imgCrop.z ? char.imgCrop.z : 1;
        
        let subText = "";
        if(currentView === 'search') subText = `<div style="font-size:0.8rem; color:#aaa;">${char.universe}</div>`;
        else if(char.subcategory) subText = `<div class="card-sub">${char.subcategory}</div>`;
        
        card.innerHTML = `<div class="card-img-wrapper"><img src="${char.img || 'https://via.placeholder.com/300?text=No+Image'}" class="card-img" style="object-position: ${cx}% ${cy}%; transform: scale(${cz}); transform-origin: ${cx}% ${cy}%;" loading="lazy" onerror="this.src='https://via.placeholder.com/300?text=Error'"></div><div class="card-info"><div class="card-name">${char.name}</div>${subText}</div>`;
        
        container.appendChild(card);
    }

    function openPage(id, direction = 0) {
        const chars = getChars();
        const char = chars.find(c => c.id === id); 
        if(!char) return;
        
        currentPlaylistIndex = characterPlaylist.indexOf(id);

        let metaHtml = `<div class="wiki-meta">`;
        if(char.realName) metaHtml += `<p><strong>Real Name</strong> ${char.realName}</p>`;
        metaHtml += `<p><strong>Universe</strong> ${char.universe}</p>`;
        if(char.subcategory) metaHtml += `<p><strong>Subcategory</strong> ${char.subcategory}</p>`;
        if(char.firstApp) metaHtml += `<p><strong>First Appearance</strong> ${char.firstApp}</p>`;
        metaHtml += `</div>`;
        
        let contentHtml = `<div class="wiki-title"><h1>${char.name}</h1>`;
        if(char.title) contentHtml += `<span>"${char.title}"</span>`;
        if(char.quote) contentHtml += `<div class="wiki-quote">"${char.quote}"</div>`;
        contentHtml += `</div>`;
        
        if(char.bio) contentHtml += `<h3>Biography</h3><p style="line-height:1.6; color:#ddd;">${char.bio}</p>`;
        
        if(char.owl || char.um || char.lbo || char.skins || char.vu) {
            contentHtml += `<h3>GWC Mechanics</h3>`;
            if(char.owl) { 
                let owlContent = `<strong>Open World Location (OWL)</strong> ${char.owl}`; 
                if(char.owlImg) owlContent += renderMediaBox(char.owlImg); 
                contentHtml += `<div class="gwc-box">${owlContent}</div>`; 
            }
            if(char.um) { 
                let umContent = `<strong>Ultimate Move (UM)</strong> ${char.um}`; 
                if(char.umMedia) umContent += renderMediaBox(char.umMedia); 
                contentHtml += `<div class="gwc-box">${umContent}</div>`; 
            }
            
            if(typeof char.lbo === 'object' && char.lbo !== null) { 
                let lboHtml = `<div class="gwc-box"><strong>Levels Based Off (LBO)</strong>`; 
                char.lbo.forEach((media) => { 
                    let rows = ""; 
                    media.levels.forEach(lvl => { 
                        if(lvl.title || lvl.desc) {
                            rows += `<div class="lbo-level-item">
                                <strong style="color:var(--text-muted); font-size:0.8rem; display:inline;">${lvl.title}</strong>: ${lvl.desc}`;
                            if(lvl.img && lvl.img.trim() !== "") {
                                rows += `<div class="lbo-level-img-container"><img src="${lvl.img}" class="lbo-level-img" onerror="this.style.display='none'"></div>`;
                            }
                            rows += `</div>`;
                        }
                    }); 
                    if(rows === "") rows = "<span style='color:#777;'>No levels defined.</span>"; 
                    
                    let bodyContent = `<div class="lbo-content-grid">`;
                    if(media.poster) {
                        bodyContent += `<img src="${media.poster}" class="lbo-poster" onerror="this.style.display='none'">`;
                    }
                    bodyContent += `<div class="lbo-level-list">${rows}</div></div>`;

                    lboHtml += `<div class="lbo-accordion"><div class="lbo-acc-header" onclick="this.nextElementSibling.classList.toggle('open')">${media.media}<span>▼</span></div><div class="lbo-acc-body">${bodyContent}</div></div>`; 
                }); 
                lboHtml += `</div>`; 
                contentHtml += lboHtml; 
            } else if(char.lbo) {
                contentHtml += `<div class="gwc-box"><strong>Levels Based Off (LBO)</strong> ${char.lbo}</div>`;
            }

            if(char.vu || char.vuImg) { 
                let vuName = char.vu || "Untitled Vehicle"; 
                let vuContent = `<strong>Vehicle (VU)</strong> ${vuName}`; 
                if(char.vuImg) { 
                    vuContent += `<button class="vehicle-toggle-btn" onclick="toggleVehiclePreview(this)">▼ Preview</button><div class="vehicle-preview-container">${renderMediaBox(char.vuImg)}</div>`; 
                } 
                contentHtml += `<div class="gwc-box">${vuContent}</div>`; 
            }
            if(char.skins) { 
                contentHtml += `<div class="gwc-box" style="border-left:none; background:transparent; padding:0;">${formatSkins(char.skins, char)}</div>`; 
            }
        }
        const cx = char.imgCrop ? char.imgCrop.x : 50; 
        const cy = char.imgCrop ? char.imgCrop.y : 50;
        const cz = char.imgCrop && char.imgCrop.z ? char.imgCrop.z : 1;
        
        const fullHtml = `<div class="wiki-sidebar"><div class="wiki-portrait-wrapper"><img src="${char.img || 'https://via.placeholder.com/300?text=No+Image'}" class="wiki-portrait" style="object-position: ${cx}% ${cy}%; transform: scale(${cz}); transform-origin: ${cx}% ${cy}%;" onerror="this.src='https://via.placeholder.com/300?text=Error'"></div>${metaHtml}</div><div class="wiki-content">${contentHtml}</div>`;
        
        const container = document.getElementById('wikiPageContainer');
        container.innerHTML = fullHtml;
        
        container.classList.remove('slide-left', 'slide-right');
        void container.offsetWidth; 
        if(direction === 1) container.classList.add('slide-right');
        if(direction === -1) container.classList.add('slide-left');
        
        document.getElementById('pageOverlay').classList.add('active');
        init3DTilt();
    }

    function navigateChar(offset) {
        if(currentPlaylistIndex === -1 || characterPlaylist.length <= 1) return;
        
        let newIndex = currentPlaylistIndex + offset;
        if (newIndex < 0) return; 
        if (newIndex >= characterPlaylist.length) return; 
        
        const nextId = characterPlaylist[newIndex];
        openPage(nextId, offset);
    }

    /* --- PARSER --- */
    function parseSkinTree(str) {
        if (!str) return [];
        let root = { type: 'root', items: [] };
        let stack = [root];
        let token = "";
        
        for (let i = 0; i < str.length; i++) {
            let char = str[i];
            if (char === ';' && str[i+1] === '(') {
                let catName = token.trim();
                let newCat = { type: 'category', name: catName, items: [] };
                stack[stack.length - 1].items.push(newCat);
                stack.push(newCat);
                token = "";
                i++; 
            } else if (char === ')') {
                if (token.trim()) stack[stack.length - 1].items.push(token.trim());
                token = "";
                if (stack.length > 1) stack.pop();
            } else if (char === ',') {
                if (token.trim()) stack[stack.length - 1].items.push(token.trim());
                token = "";
            } else {
                token += char;
            }
        }
        if (token.trim() && stack.length > 0) stack[stack.length - 1].items.push(token.trim());
        return root.items;
    }

    function formatSkins(skinString, char) {
        if(!skinString) return ''; 
        const tree = parseSkinTree(skinString);
        let html = '<div class="skins-container">';
        let sortState = { foundMain: false };

        function renderRecursive(items, prefix) {
            let directSkins = [];
            let subCats = [];
            let firstIsString = (items.length > 0 && typeof items[0] === 'string');
            items.forEach(item => {
                if(typeof item === 'string') directSkins.push(item);
                else subCats.push(item);
            });
            if(firstIsString) {
                if(directSkins.length > 0) {
                    let catName = prefix || "Misc.";
                    html += renderSkinGroup(catName, directSkins, char, sortState);
                }
                subCats.forEach(cat => {
                    let newPrefix = prefix ? `${prefix} › ${cat.name}` : cat.name;
                    renderRecursive(cat.items, newPrefix);
                });
            } else {
                subCats.forEach(cat => {
                    let newPrefix = prefix ? `${prefix} › ${cat.name}` : cat.name;
                    renderRecursive(cat.items, newPrefix);
                });
                if(directSkins.length > 0) {
                    let catName = prefix || "Misc.";
                    html += renderSkinGroup(catName, directSkins, char, sortState);
                }
            }
        }

        renderRecursive(tree, "");
        return html + '</div>';
    }

    function renderSkinGroup(category, skinList, char, sortState) {
        let html = `<div class="skin-group"><div class="skin-cat">${category}</div><div class="skin-tags">`;
        skinList.forEach(s => {
            const isFirst = !sortState.foundMain;
            if (isFirst) sortState.foundMain = true;

            let cssClass = 'skin-pill'; 
            let dataAttrs = `data-id="${char.id}" data-name="${escapeSkinName(s)}"`; 
            let events = '';
            
            if (isFirst) { 
                cssClass += ' main-skin'; 
                dataAttrs += ` data-is-main="true"`;
                events = `onclick="handleSkinClick(this)"`; 
            } else { 
                const isGwcog = s.toLowerCase().includes('gwcog') || category.toLowerCase().includes('gwcog'); 
                const data = (char.skinImages && char.skinImages[s]); 
                if(isGwcog) cssClass += ' gwcog'; 
                if(data) { 
                    cssClass += ' has-image'; 
                    dataAttrs += ` data-url="${data.url || data}" data-x="${data.x || 50}" data-y="${data.y || 50}" data-z="${data.z || 1}"`; 
                    events = `onclick="handleSkinClick(this)" onmouseenter="handleSkinHover(this, event)" onmouseleave="hideTooltip()" onmousemove="moveTooltip(event)"`; 
                }
            }
            html += `<span class="${cssClass}" ${dataAttrs} ${events}>${s}</span>`;
        });
        html += `</div></div>`; 
        return html;
    }

    function handleSkinClick(el) { 
        const url = el.getAttribute('data-url');
        const isMain = el.getAttribute('data-is-main') === 'true';
        const name = el.getAttribute('data-name');
        
        // In Read-only mode, only open if there is an image URL to show
        if (isMain) {
            const charId = parseInt(el.getAttribute('data-id'));
            const chars = getChars();
            const char = chars.find(c => c.id === charId);
            if(char && char.img) {
                openSkinModal(name, char.img, char.imgCrop);
            }
        } else if (url) {
            const x = el.getAttribute('data-x'); 
            const y = el.getAttribute('data-y'); 
            const z = el.getAttribute('data-z') || 1;
            openSkinModal(name, url, {x, y, z});
        }
    }
    
    function handleSkinHover(el, e) { 
        const url = el.getAttribute('data-url'); 
        const x = el.getAttribute('data-x'); 
        const y = el.getAttribute('data-y'); 
        const z = el.getAttribute('data-z') || 1; 
        if(url) showTooltip(e, url, x, y, z); 
    }
    
    function hideTooltip() { 
        document.getElementById('skinTooltip').style.display = 'none'; 
    }
    
    function moveTooltip(e) { 
        const tooltip = document.getElementById('skinTooltip'); 
        tooltip.style.left = (e.clientX + 15) + 'px'; 
        tooltip.style.top = (e.clientY + 15) + 'px'; 
    }
    
    function showTooltip(e, url, x, y, z) { 
        const tooltip = document.getElementById('skinTooltip'); 
        const tooltipImg = document.getElementById('skinTooltipImg'); 
        tooltipImg.src = url; 
        tooltipImg.style.objectPosition = `${x}% ${y}%`; 
        tooltipImg.style.transform = `scale(${z})`; 
        tooltipImg.style.transformOrigin = `${x}% ${y}%`; 
        tooltip.style.display = 'block'; 
        moveTooltip(e); 
    }

    function openSkinModal(skinName, url, crop = {x:50,y:50,z:1}) {
        document.getElementById('skinModalNameDisplay').innerText = skinName;
        
        const prev = document.getElementById('skinPreviewImg'); 
        prev.src = url; 
        prev.style.objectPosition = `${crop.x}% ${crop.y}%`; 
        prev.style.transform = `scale(${crop.z})`; 
        prev.style.transformOrigin = `${crop.x}% ${crop.y}%`;
        
        document.getElementById('skinOverlay').classList.add('active');
    }

    function closeSkinModalDirect() { document.getElementById('skinOverlay').classList.remove('active'); }
    function closePageDirect() { document.getElementById('pageOverlay').classList.remove('active'); }
    function closePage(e) { if(e.target.id === 'pageOverlay') closePageDirect(); }
    function closeSkinModal(e) { if(e.target.id === 'skinOverlay') closeSkinModalDirect(); }
    
    async function handleSearch() { 
        const query = document.getElementById('search').value.trim().toLowerCase(); 
        if(query.length > 0) { 
            currentView = 'search'; 
            await renderMainView(); 
        } else { 
            currentView = 'home'; 
            selectedFranchise = null; 
            await renderMainView(); 
        } 
    }
    
    async function viewMedium(medium) {
        currentView = 'medium';
        selectedMedium = medium;
        selectedFranchise = null;
        await renderMainView();
    }
    
    async function viewFranchise(franchiseName) { 
        currentView = 'franchise'; 
        selectedFranchise = franchiseName; 
        await renderMainView(); 
    }

    async function viewAbout() {
        currentView = 'about';
        await renderMainView();
    }

    async function viewStats() {
        currentView = 'stats';
        await renderMainView();
    }
    
    async function goHome() { 
        currentView = 'home'; 
        selectedFranchise = null; 
        selectedMedium = null;
        document.getElementById('search').value = ""; 
        await renderMainView(); 
    }

</script>

</body>
</html>